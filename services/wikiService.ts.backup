/**
 * WikiService - Sistema de Base de Conhecimento para IA
 * 
 * Respons√°vel por:
 * - Carregar documenta√ß√£o do Wiki
 * - Indexar conte√∫do para busca sem√¢ntica
 * - Fornecer contexto para IA Assistant
 * - Buscar respostas em documenta√ß√£o
 */

export interface WikiDocument {
  id: string;
  title: string;
  category: string;
  tags: string[];
  version: string;
  lastUpdate: string;
  author: string;
  aiContext: boolean;
  difficulty: 'b√°sico' | 'intermedi√°rio' | 'avan√ßado';
  content: string;
  path: string;
  wordCount: number;
}

export interface WikiSearchResult {
  document: WikiDocument;
  relevance: number;
  matchedSections: string[];
}

class WikiService {
  private documents: Map<string, WikiDocument> = new Map();
  private index: Map<string, Set<string>> = new Map(); // keyword -> document IDs
  private initialized = false;

  /**
   * Base de documenta√ß√£o est√°tica (ser√° carregada dinamicamente em produ√ß√£o)
   */
  private readonly WIKI_DOCS = {
    'guia-administrador': {
      id: 'guia-administrador',
      title: 'Guia do Administrador SISGEAD 3.0',
      category: 'guias-admin',
      tags: ['administrador', 'gest√£o', 'master', 'organiza√ß√µes'],
      version: '3.0.0',
      lastUpdate: '2025-11-06',
      author: 'Sistema',
      aiContext: true,
      difficulty: 'intermedi√°rio' as const,
      path: '/wiki/02-guias-administrador/guia-administrador.md',
      content: `
# Guia do Administrador SISGEAD 3.0

## N√≠veis de Acesso

### Master (Institucional)
Permiss√µes completas: gerenciar todas organiza√ß√µes, todos usu√°rios, redefinir senhas, acesso a dados consolidados, IA institucional.

### OrgAdmin (Organizacional)
Permiss√µes limitadas: gerenciar apenas sua organiza√ß√£o, criar/editar usu√°rios da org, IA organizacional.

### Member (Membro)
Permiss√µes b√°sicas: fazer avalia√ß√µes, visualizar pr√≥prio perfil, IA pessoal.

## Gest√£o de Organiza√ß√µes

### Criar Nova Organiza√ß√£o
Dashboard Master ‚Üí Organiza√ß√µes ‚Üí "+ Nova Organiza√ß√£o"

Campos: Nome, Status (Ativa/Inativa/Suspensa), M√°x Usu√°rios (padr√£o: 50), Features (Avalia√ß√µes, Relat√≥rios, Analytics, Team Builder, IA), Aprova√ß√£o de Avalia√ß√µes.

### Editar Organiza√ß√£o
Lista ‚Üí Editar ‚Üí Alterar dados, configura√ß√µes, ou EXCLUIR (irrevers√≠vel).

## Gest√£o de Usu√°rios

### Criar Novo Usu√°rio
Dashboard ‚Üí Usu√°rios ‚Üí "+ Novo Usu√°rio"

Dados: Nome, Email (login √∫nico), Telefone (opcional), Departamento, Role (Member/OrgAdmin/Master), Organiza√ß√µes, Status.

Senha inicial: Sisgead@2024 (usu√°rio DEVE trocar no primeiro login).

### Editar Usu√°rio

1. Alterar Dados: Nome, email, telefone, departamento, organiza√ß√µes, role.

2. Redefinir Senha:
   - Quando: Usu√°rio esqueceu senha, conta bloqueada, reset de seguran√ßa
   - Como: Bot√£o "Redefinir Senha" ‚Üí Senha volta para Sisgead@2024
   - Efeito: For√ßa cria√ß√£o de nova senha, remove bloqueio

3. Excluir Usu√°rio:
   - Irrevers√≠vel: Remove TODOS os dados
   - Uso: Funcion√°rio desligado, conta duplicada

## Sistema de Senhas

Senha Padr√£o: Sisgead@2024
Usado em: Novos usu√°rios, reset de senha

Pol√≠tica:
- M√≠nimo 8 caracteres
- 1 mai√∫scula, 1 min√∫scula, 1 n√∫mero, 1 especial
- Bloqueio ap√≥s 5 tentativas falhadas
- Admin desbloqueia via "Redefinir Senha"

### Fluxos Comuns

Novo Usu√°rio:
1. Admin cria ‚Üí Senha padr√£o
2. Usu√°rio recebe email
3. Primeiro login ‚Üí Pede nova senha
4. Cria senha forte ‚Üí Acesso liberado

Esqueceu Senha:
1. Usu√°rio falha login
2. Contacta admin
3. Admin "Redefinir Senha"
4. Volta para padr√£o
5. Usu√°rio cria nova

Conta Bloqueada:
1. Errou 5x ‚Üí Bloqueio
2. Admin "Redefinir Senha"
3. Bloqueio removido
4. Senha padr√£o
5. Usu√°rio cria nova

## IA Assistant

Bot√£o Flutuante: Canto inferior direito
- Master: Roxo com üëë
- OrgAdmin: Azul com üëî
- Member: Verde com üë§

Quick Actions (Master):
- Vis√£o Institucional
- Comparar Organiza√ß√µes
- Mapeamento de Talentos
- Insights Estrat√©gicos

Exemplos de Perguntas:
- "Quantos usu√°rios ativos?"
- "Quais organiza√ß√µes inativas?"
- "Como redefinir senha?"
- "Distribui√ß√£o de perfis DISC?"

## Troubleshooting

Usu√°rio n√£o loga:
‚Üí Editar Usu√°rio ‚Üí Redefinir Senha

Organiza√ß√£o n√£o aparece:
‚Üí Editar Usu√°rio ‚Üí Organiza√ß√µes ‚Üí Marcar ‚Üí Salvar

IA n√£o aparece:
‚Üí Verificar feature "ai-assistant" na org
      `,
      wordCount: 450
    },

    'sistema-senhas': {
      id: 'sistema-senhas',
      title: 'Sistema de Gerenciamento de Senhas',
      category: 'guias-admin',
      tags: ['senha', 'seguran√ßa', 'reset', 'bloqueio'],
      version: '3.0.0',
      lastUpdate: '2025-11-06',
      author: 'Sistema',
      aiContext: true,
      difficulty: 'b√°sico' as const,
      path: '/wiki/02-guias-administrador/sistema-senhas.md',
      content: `
# Sistema de Senhas SISGEAD 3.0

## Senha Padr√£o

Senha: Sisgead@2024

Quando √© usada:
- Cria√ß√£o de novos usu√°rios
- Reset de senha por administrador
- Recupera√ß√£o de conta bloqueada

Seguran√ßa:
- Usu√°rio N√ÉO pode manter senha padr√£o
- Sistema FOR√áA troca no primeiro login
- Campo requirePasswordChange: true

## Pol√≠tica de Senhas

Requisitos obrigat√≥rios:
‚úì M√≠nimo 8 caracteres
‚úì Pelo menos 1 letra mai√∫scula
‚úì Pelo menos 1 letra min√∫scula
‚úì Pelo menos 1 n√∫mero
‚úì Pelo menos 1 caractere especial (@, #, $, %, etc.)

Bloqueio autom√°tico:
- Ap√≥s 5 tentativas falhadas de login
- Admin pode desbloquear via "Redefinir Senha"

## Redefinir Senha (Admin)

Acesso: Editar Usu√°rio ‚Üí Bot√£o "Redefinir Senha" (amarelo)

O que acontece:
1. Senha volta para Sisgead@2024
2. requirePasswordChange = true (for√ßa nova senha)
3. failedLoginAttempts = 0 (limpa tentativas)
4. isLocked = false (desbloqueia conta)

Quando usar:
- Usu√°rio esqueceu a senha
- Conta bloqueada por tentativas falhadas
- Reset de seguran√ßa (suspeita de comprometimento)

## Fluxos Completos

### Novo Usu√°rio
1. Admin cria usu√°rio
2. Sistema define senha = Sisgead@2024
3. requirePasswordChange = true
4. Usu√°rio recebe credenciais
5. Primeiro login detecta requirePasswordChange
6. Formul√°rio de nova senha aparece
7. Usu√°rio cria senha forte
8. requirePasswordChange = false
9. Login normal liberado

### Usu√°rio Esqueceu Senha
1. Usu√°rio tenta logar e falha
2. Usu√°rio contacta administrador
3. Admin acessa: Dashboard ‚Üí Usu√°rios ‚Üí Editar Usu√°rio
4. Admin clica "Redefinir Senha"
5. Modal de confirma√ß√£o aparece
6. Admin confirma
7. Sistema reseta senha para Sisgead@2024
8. Admin informa usu√°rio da senha tempor√°ria
9. Usu√°rio faz login com Sisgead@2024
10. Sistema for√ßa cria√ß√£o de nova senha
11. Acesso liberado

### Conta Bloqueada
1. Usu√°rio erra senha 5 vezes
2. Sistema bloqueia: isLocked = true
3. Mensagem: "Conta bloqueada. Contacte administrador"
4. Usu√°rio contacta admin
5. Admin: Editar Usu√°rio ‚Üí Redefinir Senha
6. Sistema automaticamente:
   - isLocked = false
   - failedLoginAttempts = 0
   - senha = Sisgead@2024
   - requirePasswordChange = true
7. Admin informa usu√°rio
8. Usu√°rio loga e cria nova senha

## Boas Pr√°ticas

Para Administradores:
‚úì Sempre informe o usu√°rio ap√≥s redefinir senha
‚úì Pe√ßa confirma√ß√£o de identidade antes de resetar
‚úì Documente resets frequentes (pode indicar problema)
‚úì Oriente sobre pol√≠tica de senhas fortes

Para Usu√°rios:
‚úì Use gerenciador de senhas (LastPass, 1Password)
‚úì Nunca compartilhe senha
‚úì Troque regularmente (sugest√£o: 90 dias)
‚úì Use senhas diferentes por sistema

## Seguran√ßa T√©cnica

Hash de Senha:
- Algoritmo: bcrypt (cost factor 10)
- Salt autom√°tico
- Nunca armazenada em plain text

Valida√ß√£o:
- Frontend: Regex para requisitos
- Backend: bcrypt.compare() para verifica√ß√£o
- Timeout: 3 segundos para prevenir timing attacks

Auditoria:
- lastPasswordChange registrado
- failedLoginAttempts incrementado
- isLocked quando ‚â• 5 tentativas
      `,
      wordCount: 380
    },

    'arquitetura-ia-dual': {
      id: 'arquitetura-ia-dual',
      title: 'Arquitetura IA Dual-Level',
      category: 'arquitetura',
      tags: ['ia', 'arquitetura', 'gemini', 'contexto'],
      version: '3.0.0',
      lastUpdate: '2025-11-06',
      author: 'Sistema',
      aiContext: true,
      difficulty: 'avan√ßado' as const,
      path: '/wiki/03-arquitetura/arquitetura-ia-dual-level.md',
      content: `
# Arquitetura IA Dual-Level

## Conceito

Sistema de IA com dois n√≠veis de contexto:

1. Institucional (Master/OrgAdmin)
   - Acesso a TODOS os dados da institui√ß√£o
   - An√°lise cross-org
   - Insights estrat√©gicos

2. Organizacional (OrgAdmin/Member)
   - Acesso a dados de UMA organiza√ß√£o
   - An√°lise isolada
   - Workspace v2.0 dedicado

## Componentes

AIContext:
- Provedor global de estado
- useAI() hook
- useAIAccess() hook
- Gerencia conversa√ß√£o e contexto

AIFloatingButton:
- Adaptativo por role
- Master: Roxo üëë
- OrgAdmin: Azul üëî
- Member: Verde üë§

UnifiedAIModal:
- Interface contextual
- Quick actions por role
- Hist√≥rico de conversa√ß√£o

## Contexto Data

Master v√™:
- currentInstitution
- allOrganizations[]
- allUsers[]
- consolidatedAssessments[]

OrgAdmin v√™:
- currentOrganization
- orgUsers[]
- orgAssessments[]

Member v√™:
- currentUser
- ownAssessments[]

## Integra√ß√£o Gemini

geminiService.ts (v2.0):
- Cloudflare Worker proxy
- Mock mode fallback
- GoogleGenAI SDK

PremiumAIService (futuro):
- queryInstitutional()
- queryOrganizational()
- queryPersonal()
      `,
      wordCount: 180
    }
  };

  /**
   * Inicializar servi√ßo (carregar docs)
   */
  async initialize(): Promise<void> {
    if (this.initialized) return;

    // Carregar documentos da base est√°tica
    Object.values(this.WIKI_DOCS).forEach(doc => {
      this.documents.set(doc.id, doc);
      this.indexDocument(doc);
    });

    this.initialized = true;
    console.log(`‚úÖ WikiService initialized with ${this.documents.size} documents`);
  }

  /**
   * Indexar documento para busca
   */
  private indexDocument(doc: WikiDocument): void {
    if (!doc.aiContext) return; // S√≥ indexa docs marcados para IA

    // Extrair keywords do conte√∫do
    const keywords = this.extractKeywords(doc.content + ' ' + doc.title + ' ' + doc.tags.join(' '));
    
    keywords.forEach(keyword => {
      if (!this.index.has(keyword)) {
        this.index.set(keyword, new Set());
      }
      this.index.get(keyword)!.add(doc.id);
    });
  }

  /**
   * Extrair keywords relevantes do texto
   */
  private extractKeywords(text: string): string[] {
    // Normalizar texto
    const normalized = text.toLowerCase()
      .replace(/[^\w\s√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();

    // Palavras stop (ignorar)
    const stopWords = new Set([
      'o', 'a', 'os', 'as', 'um', 'uma', 'de', 'do', 'da', 'dos', 'das',
      'em', 'no', 'na', 'nos', 'nas', 'para', 'com', 'por', 'e', 'ou',
      'que', 'se', '√©', 's√£o', 'como', 'quando', 'onde', 'qual', 'quais'
    ]);

    // Split e filtrar
    return normalized
      .split(' ')
      .filter(word => word.length > 2 && !stopWords.has(word))
      .filter((word, index, arr) => arr.indexOf(word) === index); // Unique
  }

  /**
   * Buscar documentos relevantes
   */
  async search(query: string, limit: number = 3): Promise<WikiSearchResult[]> {
    await this.initialize();

    const queryKeywords = this.extractKeywords(query);
    const scores = new Map<string, number>();

    // Calcular score de relev√¢ncia para cada documento
    queryKeywords.forEach(keyword => {
      const matchingDocs = this.index.get(keyword);
      if (matchingDocs) {
        matchingDocs.forEach(docId => {
          scores.set(docId, (scores.get(docId) || 0) + 1);
        });
      }
    });

    // Ordenar por relev√¢ncia
    const results: WikiSearchResult[] = Array.from(scores.entries())
      .map(([docId, score]) => {
        const doc = this.documents.get(docId)!;
        return {
          document: doc,
          relevance: score / queryKeywords.length,
          matchedSections: this.findMatchedSections(doc, queryKeywords)
        };
      })
      .sort((a, b) => b.relevance - a.relevance)
      .slice(0, limit);

    return results;
  }

  /**
   * Encontrar se√ß√µes do documento que cont√™m keywords
   */
  private findMatchedSections(doc: WikiDocument, keywords: string[]): string[] {
    const sections: string[] = [];
    const lines = doc.content.split('\n');
    
    let currentSection = '';
    for (const line of lines) {
      if (line.startsWith('#')) {
        currentSection = line.replace(/^#+\s*/, '');
      }
      
      const hasMatch = keywords.some(kw => line.toLowerCase().includes(kw));
      if (hasMatch && currentSection && !sections.includes(currentSection)) {
        sections.push(currentSection);
      }
    }

    return sections.slice(0, 3); // M√°ximo 3 se√ß√µes
  }

  /**
   * Obter documento por ID
   */
  async getDocument(id: string): Promise<WikiDocument | null> {
    await this.initialize();
    return this.documents.get(id) || null;
  }

  /**
   * Obter todos os documentos de uma categoria
   */
  async getByCategory(category: string): Promise<WikiDocument[]> {
    await this.initialize();
    return Array.from(this.documents.values())
      .filter(doc => doc.category === category);
  }

  /**
   * Gerar contexto para IA baseado em query
   */
  async getContextForAI(query: string): Promise<string> {
    const results = await this.search(query, 2); // Top 2 docs mais relevantes

    if (results.length === 0) {
      return 'Nenhuma documenta√ß√£o espec√≠fica encontrada para esta pergunta.';
    }

    let context = 'üìö DOCUMENTA√á√ÉO RELEVANTE:\n\n';
    
    results.forEach((result, index) => {
      context += `--- ${index + 1}. ${result.document.title} (${Math.round(result.relevance * 100)}% relevante) ---\n`;
      context += result.document.content.substring(0, 800); // Primeiros 800 chars
      if (result.matchedSections.length > 0) {
        context += `\n\nSe√ß√µes relevantes: ${result.matchedSections.join(', ')}`;
      }
      context += '\n\n';
    });

    return context;
  }

  /**
   * Listar todos os documentos (para debug)
   */
  async listAll(): Promise<WikiDocument[]> {
    await this.initialize();
    return Array.from(this.documents.values());
  }
}

export const wikiService = new WikiService();
